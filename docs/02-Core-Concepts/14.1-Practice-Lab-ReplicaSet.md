### 14.1.1 Create ReplicaSet

A ReplicaSet (RS) is a core Kubernetes resource (a controller) that ensures a specified number of identical Pod replicas are running at all times.

A ReplicaSet ensures availability, self-healing for these stateless workloads _(A stateless workload is an application that does NOT store any data or session information inside the pod.)_.

ReplicaSet uses `labels`, `selectors` to match Pods

üß© **Key Functions (Self-Healing & Scaling):**

* **Self-Healing (High Availability):** If a Pod fails, crashes, or is deleted for any reason (e.g., node failure), the ReplicaSet automatically creates a new replacement Pod to maintain the desired replica count.

* **Scaling:** It allows you to easily scale your application up (increase replicas) or down (decrease replicas) by changing the replicas field.

üß© **Create ReplicaSet - IMPERATIVE** _(rare, but CKA asks sometimes)_

Kubernetes does NOT provide a direct full imperative generator for ReplicaSets
_(like it does for Pods, Deployments, Jobs, etc.)_

However, you can create a basic ReplicaSet imperatively using:

Simple imperative command

```bash
kubectl create rs myapp-rs --image=nginx --replicas=3
```
This creates a minimal ReplicaSet with default labels and a simple Pod template. Recommended Imperative Workflow

1Ô∏è‚É£ Generate YAML imperatively
```bash
kubectl create rs myapp-rs --image=nginx --replicas=3 --dry-run=client -o yaml > rs.yaml
```

2Ô∏è‚É£ Edit `rs.yaml` and add your labels:
```yaml title="rs.yaml" linenums="1"
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: myapp-rs
  labels:                     # Labels for the ReplicaSet resource
    app: nginx-app
    tier: frontend
spec:
  replicas: 3                 # Number of Pods to maintain
  selector:                   # MUST match template labels
    matchLabels:
      app: nginx-app
  template:                   # Pod template
    metadata:
      labels:                 # MUST match selector labels
        app: nginx-app
        tier: frontend
    spec:
      containers:
      - name: nginx
        image: nginx          # Container image
```
`selector.matchLabels` must match `template.metadata.labels` If they don't match `ReplicaSet` will not create Pods

3Ô∏è‚É£ Apply the updated ReplicaSet
```bash
kubectl apply -f rs.yaml
```

4Ô∏è‚É£ verify:
```bash
kubectl get rs
kubectl get pods -l app=myapp-rs
```

üî∏ Useful Imperative Editing Commands


```bash
# Add a new label to ReplicaSet
kubectl label rs myapp-rs env=dev

# Remove a label
kubectl label rs myapp-rs env-

# Patch ReplicaSet (advanced)
kubectl patch rs myapp-rs -p '{"spec": {"replicas": 5}}'

# Scale ReplicaSet
kubectl scale rs myapp-rs --replicas=5
```

!!! Important
    - Imperative ReplicaSet creation is limited.
    - If you need custom labels, ports, environment vars, volumes, etc.,
    - you must use declarative YAML.

!!! Summary
    - Added labels: app: nginx-app and tier: frontend
    - Updated selector to match app: nginx-app
    - Updated Pod template labels to match selector
    - Now ReplicaSet will manage only Pods with label app=nginx-app

üß© **Create ReplicaSet ‚Äì Declarative**

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nginx-rs
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:latest
```

```bash
kubectl apply -f replicaset.yaml
```

```bash
kubectl get rs
kubectl get pods -l app=nginx
```

**Scale Pods using Labels**
List all RS:
```
kubectl get rs --show-labels
```

Scale a specific RS by label:
```
kubectl scale rs -l app=nginx --replicas=4
```

Scale all RS in a namespace:
```
kubectl scale rs --all --replicas=2
```

**Inspect & Describe**

Get YAML:
kubectl get rs nginx-rs -o yaml


Describe:
kubectl describe rs nginx-rs


View events:
kubectl describe rs nginx-rs | grep -i event -A5


**Delete Pods (effect on ReplicaSet)**

Delete one Pod:
kubectl delete pod <name>
ReplicaSet recreates it automatically.

Delete RS but keep Pods:
kubectl delete rs nginx-rs --cascade=orphan


Delete RS + Pods:
kubectl delete rs nginx-rs

**Advanced: Multiple ReplicaSets**
Example:

RS1 selects app=web
RS2 selects app=web, env=prod

Only Pods matching selectors belong to that RS.

Check:
```
kubectl get pods --show-labels
kubectl describe rs rs1
kubectl describe rs rs2
```

**Master Level Example ‚Äì Scale all RS by label**
Task: "Scale all Nginx ReplicaSets to 6 replicas"

Solution:

kubectl scale rs -l app=nginx --replicas=6


Task: "Delete all Pods controlled by RS"

Solution:

kubectl delete pods -l app=nginx


ReplicaSet will recreate them.

**FULL MASTER LAB (Copy‚ÄìPaste Practice)**
Run everything step-by-step:
```
kubectl apply -f replicaset.yaml
kubectl get rs
kubectl get pods -o wide

kubectl scale rs nginx-rs --replicas=5
kubectl get pods -l app=nginx

kubectl describe rs nginx-rs

kubectl delete pod <any-pod>
kubectl get pods # new one will be created

kubectl scale rs -l app=nginx --replicas=2

kubectl delete rs nginx-rs --cascade=orphan
kubectl get pods # pods stay

kubectl delete pods -l app=nginx
```


!!! important
    - `selector.matchLabels` MUST match `template.labels`. If they don‚Äôt match ‚Üí `ReplicaSet` will create 0 pods.
    - **ReplicaSet does NOT do rolling updates**. Only Deployment does rollout. RS will delete/add pods only to maintain replica count.
    - To scale ReplicaSet
        - `kubectl scale rs myapp-rs --replicas=5`

> You should NOT use `Deployment` and `ReplicaSet` together manually. Best practice to Use `Deployment` ONLY. A `Deployment` automatically creates and manages a `ReplicaSet`, so you never manually create a ReplicaSet when using a Deployment.

---

### 14.1.2 Inspect and Describe

üß© **List `ReplicaSets`**
```bash
kubectl get replicasets
```

```bash
kubectl get rs
```

```bash
# Show with wide output:
kubectl get rs -o wide
```

‚ö°Ô∏è **Describe a `ReplicaSet`**

Shows labels, selectors, events, pod details.
```bash
kubectl describe rs <replicaset-name>
```

!!! info
    Look for:

      * Selector
      * Replicas _(desired/current/ready)_
      * Template
      * Events _(FailedScheduling, image errors)_

‚ö°Ô∏è **Inspect Pods Controlled by a ReplicaSet**

ReplicaSet controls Pods using labels.

Find Pods:
```bash
kubectl get pods --selector=app=nginx
```

OR

```bash
kubectl get pods -l app=nginx
```
Show pod labels:
```bash
kubectl get pods --show-labels
```

‚ö°Ô∏è **Inspect ReplicaSet YAML (Full Manifest)**
```bash
kubectl get rs <rs-name> -o yaml
```

Useful to check:

  * `spec.selector.matchLabels`
  * `spec.template.metadata.labels`
  * `spec.replicas`

‚ö°Ô∏è **Check ReplicaSet Events**
```bash
kubectl describe rs <rs-name> | grep -i event -A5
```
Look for:

  * `ImagePullBackOff`
  * FailedScheduling (node taints)
  * Pod quota issues

‚ö°Ô∏è **Show Replica Count**
```bash
kubectl get rs <rs-name> -o jsonpath='{.status}'
```
---


### 14.1.3 Scale ReplicaSet (Imperative & Declarative)

##### ‚ú¥Ô∏è Imperative Method

Imperative scaling refers to directly using kubectl commands to change the state of resources. To scale a ReplicaSet, you'd use the kubectl scale command.

‚ö°Ô∏è **Scaling a ReplicaSet by number of `--replicas`:**

You can scale a ReplicaSet to a specific number of replicas using the following command:
```bash
kubectl scale replicaset myapp-replicaset --replicas=5
```
This command scales the `myapp-replicaset` to 5 replicas.

‚ö°Ô∏è **Scaling a ReplicaSet based on the resource `label`:**

If you have multiple ReplicaSets and want to scale one of them based on a label selector, you can do:
```bash
kubectl scale replicaset -l app=myapp --replicas=3
```
This command scales all ReplicaSets that match the label `app=myapp` to 3 replicas.

##### ‚ú¥Ô∏è Imperative Method

### 14.1.4 Delete Pod ‚Üí Observe Re-creation
### 14.1.5 Scale Down Replica Count
### 14.1.6 Add Resource Limits
### 14.1.7 Delete ReplicaSet (with/without Pods)
### 14.1.8 Retain Pods While Deleting ReplicaSet
### 14.1.9 Convert ReplicaSet ‚Üí Deployment
### 14.1.10 Debug ReplicaSet (Ownership, Events, Orphaned Pods)