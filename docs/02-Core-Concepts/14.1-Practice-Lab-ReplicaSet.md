### 14.1.1 Create ReplicaSet

A ReplicaSet (RS) is a core Kubernetes resource (a controller) that ensures a specified number of identical Pod replicas are running at all times.

A ReplicaSet ensures availability, self-healing for these stateless workloads _(A stateless workload is an application that does NOT store any data or session information inside the pod.)_.

ReplicaSet uses `labels`, `selectors` to match Pods

ðŸ§© **Key Functions (Self-Healing & Scaling):**

* **Self-Healing (High Availability):** If a Pod fails, crashes, or is deleted for any reason (e.g., node failure), the ReplicaSet automatically creates a new replacement Pod to maintain the desired replica count.

* **Scaling:** It allows you to easily scale your application up (increase replicas) or down (decrease replicas) by changing the replicas field.

ðŸ§© **Create ReplicaSet - IMPERATIVE** _(rare, but CKA asks sometimes)_

Kubernetes does NOT provide a direct full imperative generator for ReplicaSets
_(like it does for Pods, Deployments, Jobs, etc.)_

However, you can create a basic ReplicaSet imperatively using:

Simple imperative command

```bash
kubectl create rs myapp-rs --image=nginx --replicas=3
```
This creates a minimal ReplicaSet with default labels and a simple Pod template. Recommended Imperative Workflow

1ï¸âƒ£ Generate YAML imperatively
```bash
kubectl create rs myapp-rs --image=nginx --replicas=3 --dry-run=client -o yaml > rs.yaml
```

2ï¸âƒ£ Edit `rs.yaml` and add your labels:
```yaml title="rs.yaml" linenums="1"
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: myapp-rs
  labels:                     # Labels for the ReplicaSet resource
    app: nginx-app
    tier: frontend
spec:
  replicas: 3                 # Number of Pods to maintain
  selector:                   # MUST match template labels
    matchLabels:
      app: nginx-app
  template:                   # Pod template
    metadata:
      labels:                 # MUST match selector labels
        app: nginx-app
        tier: frontend
    spec:
      containers:
      - name: nginx
        image: nginx          # Container image
```
`selector.matchLabels` must match `template.metadata.labels` If they don't match `ReplicaSet` will not create Pods

3ï¸âƒ£ Apply the updated ReplicaSet
```bash
kubectl apply -f rs.yaml
```

4ï¸âƒ£ verify:
```bash
kubectl get rs
kubectl get pods -l app=myapp-rs
```

ðŸ”¸ Useful Imperative Editing Commands


```bash
# Add a new label to ReplicaSet
kubectl label rs myapp-rs env=dev

# Remove a label
kubectl label rs myapp-rs env-

# Patch ReplicaSet (advanced)
kubectl patch rs myapp-rs -p '{"spec": {"replicas": 5}}'

# Scale ReplicaSet
kubectl scale rs myapp-rs --replicas=5
```

> [!IMPORTANT]
>    - Imperative ReplicaSet creation is limited.
>    - If you need custom labels, ports, environment vars, volumes, etc.,
>    - you must use declarative YAML.

> [!NOTE]
>    - Added labels: app: nginx-app and tier: frontend
>    - Updated selector to match app: nginx-app
>    - Updated Pod template labels to match selector
>    - Now ReplicaSet will manage only Pods with label app=nginx-app

> [!NOTE]
>    `kubectl patch` used to partially update a kubernetes resource, to modify only specific fields, no need to edit or re-apply the full YAML
>    - Patch â‰  Replace
>    - Patch changes only what you specify
>    - example `kubectl patch rs myapp-rs -p '{"spec": {"replicas": 5}}'`

ðŸ§© **Create ReplicaSet â€“ Declarative**

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nginx-rs
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:latest
```

```bash
kubectl apply -f replicaset.yaml
```

```bash
kubectl get rs
kubectl get pods -l app=nginx
```

**Scale Pods using Labels**
List all RS:
```
kubectl get rs --show-labels
```

Scale a specific RS by label:
```
kubectl scale rs -l app=nginx --replicas=4
```

Scale all RS in a namespace:
```
kubectl scale rs --all --replicas=2
```

**Inspect & Describe**

Get YAML:
```bash
kubectl get rs nginx-rs -o yaml
```

Describe:
```bash
kubectl describe rs nginx-rs
```

View events:
```bash
kubectl describe rs nginx-rs | grep -i event -A5
```

**Delete Pods (effect on ReplicaSet)**

Delete one Pod:
```bash
kubectl delete pod <name>
```
ReplicaSet recreates it automatically.

Delete RS but keep Pods:
```bash
kubectl delete rs nginx-rs --cascade=orphan
```

Delete RS + Pods:
```bash
kubectl delete rs nginx-rs
```

**Advanced: Multiple ReplicaSets**
Example:

RS1 selects app=web
RS2 selects app=web, env=prod

Only Pods matching selectors belong to that RS.

Check:
```
kubectl get pods --show-labels
kubectl describe rs rs1
kubectl describe rs rs2
```

**Master Level Example â€“ Scale all RS by label**
Task: "Scale all Nginx ReplicaSets to 6 replicas"

Solution:
```bash
kubectl scale rs -l app=nginx --replicas=6
```

Task: "Delete all Pods controlled by RS"

Solution:
```bash
kubectl delete pods -l app=nginx
```

ReplicaSet will recreate them.

**FULL MASTER LAB (Copyâ€“Paste Practice)**
Run everything step-by-step:
```
kubectl apply -f replicaset.yaml
kubectl get rs
kubectl get pods -o wide

kubectl scale rs nginx-rs --replicas=5
kubectl get pods -l app=nginx

kubectl describe rs nginx-rs

kubectl delete pod <any-pod>
kubectl get pods # new one will be created

kubectl scale rs -l app=nginx --replicas=2

kubectl delete rs nginx-rs --cascade=orphan
kubectl get pods # pods stay

kubectl delete pods -l app=nginx
```


> [!IMPORTANT]
>    - `selector.matchLabels` MUST match `template.labels`. If they donâ€™t match â†’ `ReplicaSet` will create 0 pods.
>    - **ReplicaSet does NOT do rolling updates**. Only Deployment does rollout. RS will delete/add pods only to maintain replica count.
>    - To scale ReplicaSet
>        - `kubectl scale rs myapp-rs --replicas=5`

> You should NOT use `Deployment` and `ReplicaSet` together manually. Best practice to Use `Deployment` ONLY. A `Deployment` automatically creates and manages a `ReplicaSet`, so you never manually create a ReplicaSet when using a Deployment.

---

### 14.1.2 Inspect and Describe

ðŸ§© **List `ReplicaSets`**
```bash
kubectl get replicasets
```

```bash
kubectl get rs
```

```bash
# Show with wide output:
kubectl get rs -o wide
```

ðŸ§© **Describe a `ReplicaSet`**

Shows labels, selectors, events, pod details.
```bash
kubectl describe rs <replicaset-name>
```

> [!NOTE]
>    Look for:
>
>      * Selector
>      * Replicas _(desired/current/ready)_
>      * Template
>      * Events _(FailedScheduling, image errors)_

ðŸ§© **Inspect Pods Controlled by a ReplicaSet**

ReplicaSet controls Pods using labels.

Find Pods:
```bash
kubectl get pods --selector=app=nginx
```

OR

```bash
kubectl get pods -l app=nginx
```
Show pod labels:
```bash
kubectl get pods --show-labels
```

ðŸ§© **Inspect ReplicaSet YAML (Full Manifest)**
```bash
kubectl get rs <rs-name> -o yaml
```

Useful to check:

  * `spec.selector.matchLabels`
  * `spec.template.metadata.labels`
  * `spec.replicas`

ðŸ§© **Check ReplicaSet Events**
```bash
kubectl describe rs <rs-name> | grep -i event -A5
```
Look for:

  * `ImagePullBackOff`
  * FailedScheduling (node taints)
  * Pod quota issues

ðŸ§© **Show Replica Count**
```bash
kubectl get rs <rs-name> -o jsonpath='{.status}'
```
---

### 14.1.3 Delete Pod â†’ Observe Re-creation

ReplicaSet automatically creates a new Pod
```bash
kubectl get pods
kubectl delete pod <pod-name>
kubectl get pods
```

### 14.1.4 Scale Down Replica Count

ReplicaSet deletes extra Pods.
```bash
kubectl scale rs nginx-rs --replicas=1
kubectl get pods
```

### 14.1.5 Add Resource Limits

Edit ReplicaSet YAML

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nginx-rs
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:latest
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "250m"
              memory: "256Mi"
```
Apply:
```bash
kubectl apply -f replicaset.yaml
```

Verify:
```bash
kubectl describe pod <pod-name>
```

### 14.1.6 Delete ReplicaSet (with/without Pods)

Delete ReplicaSet + Pods (default)
```bash
kubectl delete rs nginx-rs
```

Delete ReplicaSet but keep Pods
```bash
kubectl delete rs nginx-rs --cascade=orphan
```

### 14.1.7 Retain Pods While Deleting ReplicaSet

Pods become orphaned (no controller).
```bash
kubectl delete rs nginx-rs --cascade=orphan
kubectl get pods
```

- This deletes the ReplicaSet object only
- The `--cascade=orphan` flag tells Kubernetes: **"Do NOT delete the child resources"**
- Orphaned Pod = a Pod with no owning controller
- The Pods that were created by nginx-rs continue running
- They are no longer managed by any controller
- You can confirm this:
   ```bash
   kubectl get pods
   kubectl describe pod <pod-name>
   ```
   You'll see
   ```bash
   Controlled By: <none>
   ```
- `--cascade=orphan` removes the controller without removing OwnerReferences cleanup

### 14.1.8 Convert ReplicaSet â†’ Deployment

Why Convert to Deployment?
 - Rolling updates
 - Rollbacks
 - Versioning

Deployment using same labels
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deploy
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.25
```

Apply
```bash
kubectl apply -f deployment.yaml
```

> [!WARNING]
> If a ReplicaSet is created and managed by a Deployment, you should NEVER manually edit, scale, or manage that ReplicaSet directly. You must manage only the Deployment.
> A Deployment is the boss. It creates, updates, scales, and replaces ReplicaSets automatically.
> If you manually touch the ReplicaSet:
>  - Deployment will override your changes
>  - You may break rolling updates
>  - You may cause unexpected scaling or pod deletion


### 14.1.9 Debug ReplicaSet (Ownership, Events, Orphaned Pods)

Check ownership
```bash
kubectl get pod <pod-name> -o yaml | grep ownerReferences -A5
```

Check events
```bash
kubectl describe rs nginx-rs | grep -i event -A5
```